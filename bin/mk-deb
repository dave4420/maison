#!/bin/bash
set -e
set -o pipefail

die() {
    printf "$@" >&2
    exit 2
}


readonly dist="$(lsb_release -si)"
readonly dist_version_name="$(lsb_release -sc)"
case "$dist-$dist_version_name" in
    Ubuntu-trusty)      readonly dist_version_number=12.04 ;;
    Ubuntu-precise)     readonly dist_version_number=14.04 ;;
    *)                  die 'Unknown OS version: %s-%s\n' \
                            "$dist" "$dist_version_name" ;;
esac


cd "$(git rev-parse --show-toplevel)"
hs18 build

readonly nd_build=(.sandboxen/*/dist/build)
if [[ "${#nd_build[@]}" != 1 ]] ; then
    die "Was expecting 1 subdirectory of .sandboxen, but found %d\n" \
        "${#nd_build[@]}"
fi

on_exit() {
    rm -rf package
}
trap on_exit EXIT


build-deb-for-binary() {
    local -r orig="$1"
    local -r nf_orig="$nd_build/$orig/$orig"
    if ! [[ -x "$nf_orig" ]] ; then
        return
    fi
    rm -rf package
    mkdir -p pkg package/{usr/bin,etc/init,DEBIAN}
    cp "$nf_orig" "package/usr/bin/dave4420-$orig"
    cat >"package/etc/init/dave4420-$orig" <<EOF
description "$orig custom webserver"
author "Dave <beakerchu@googlemail.com>"
start on (local-filesystems and net-device-up)
stop on runlevel [!2345]
respawn
env LANG=en_GB.UTF-8
exec /usr/bin/dave4420-$orig daemon
EOF
    cat >package/DEBIAN/control <<EOF
Package: dave4420-$orig
Priority: optional
Section: web
Installed-size: 10000
Maintainer: Dave Hinton
Architecture: amd64
Version: $dist_version_number.$(date +'%Y%m%d.%H%M')
Depends: libc6, zlib1g, libgmp10
Description: $orig custom web server.
EOF
    # Installed-size is in K
    fakeroot dpkg-deb -z8 -Zgzip --build package pkg
}


for orig in maison chateau ; do
    build-deb-for-binary "$orig"
done
